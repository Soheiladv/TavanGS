{% extends "base/base.html" %}

{% load jalali_filters %}
{% load static %}
{% load jformat %}

 

{% block content %}
    <div class="container my-3 my-md-4">
        <div class="d-flex flex-column flex-lg-row align-items-stretch gap-2 gap-lg-3 mb-3">
            <form method="get" class="w-100">
                <div class="d-flex flex-wrap gap-2">
                    <div class="flex-fill" style="min-width:220px;">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" name="search" class="form-control" placeholder="جستجو در مسیر، جزئیات و تغییرات" value="{{ request.GET.search }}">
                        </div>
                    </div>
                    <div style="min-width:180px;">
                        <select name="user" class="form-select">
                            <option value="">همه کاربران</option>
                            {% for user in users %}
                                <option value="{{ user.id }}" {% if request.GET.user|stringformat:"s" == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="min-width:160px;">
                        <select name="action" class="form-select">
                            <option value="">همه عملیات‌ها</option>
                            <option value="create" {% if request.GET.action == 'create' %}selected{% endif %}>افزودن</option>
                            <option value="update" {% if request.GET.action == 'update' %}selected{% endif %}>بروزرسانی</option>
                            <option value="delete" {% if request.GET.action == 'delete' %}selected{% endif %}>حذف</option>
                        </select>
                    </div>
                    <div style="min-width:200px;">
                        <select name="model_name" class="form-select">
                            <option value="">همه مدل‌ها</option>
                            {% for model in models %}
                                <option value="{{ model.model_name }}" {% if request.GET.model_name == model.model_name %}selected{% endif %}>{{ model.verbose_name_plural }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="min-width:150px;">
                        <input type="text" id="date_from" name="date_from" autocomplete="off" class="form-control" data-jdp placeholder="از تاریخ (1404/01/01)" value="{{ request.GET.date_from }}">
                    </div>
                    <div style="min-width:150px;">
                        <input type="text" id="date_to" name="date_to" autocomplete="off" class="form-control" data-jdp placeholder="تا تاریخ (1404/12/29)" value="{{ request.GET.date_to }}">
                    </div>
                    <div class="w-100 d-none"></div>
                    <div class="flex-fill" style="min-width:220px;">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-route"></i></span>
                            <input type="text" name="path" class="form-control" placeholder="مسیر/تمپلیت" value="{{ request.GET.path }}">
                        </div>
                    </div>
                    <div class="ms-auto d-flex gap-2">
                        <input type="hidden" name="show_empty" value="{% if not show_empty %}true{% else %}false{% endif %}">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-filter ms-1"></i>اعمال</button>
                        <a href="{% url 'accounts:audit_log_list' %}" class="btn btn-outline-secondary"><i class="fas fa-undo ms-1"></i>بازنشانی </a>
                    </div>
                </div>
            </form>
        </div>

        <div class="logs-list">
            {% for log in logs %}
                <div class="card border-0 shadow-sm mb-2">
                    <div class="card-body py-2" data-bs-toggle="collapse" data-bs-target="#log{{ log.id }}">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <span class="text-muted small"><i class="fas fa-hashtag ms-1"></i>{{ log.id }}</span>
                            <span class="small"><i class="fas fa-user ms-1"></i>{{ log.user_id|default:"سیستم" }}</span>
                            {% if log.action == 'create' %}
                                <span class="badge bg-success">افزودن</span>
                            {% elif log.action == 'update' %}
                                <span class="badge bg-warning text-dark">بروزرسانی</span>
                            {% elif log.action == 'delete' %}
                                <span class="badge bg-danger">حذف</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ log.get_action_display }}</span>
                            {% endif %}
                            <span class="small text-muted ms-auto"><i class="fas fa-clock ms-1"></i>{{ log.timestamp|to_jalali:'%Y/%m/%d %H:%M:%S' }}</span>
                        </div>
                        {% if log.changes and log.changes != '-' and log.changes != '' %}
                            <div class="mt-2 text-muted small">
                                {% for field, values in log.changes.items %}
                                    <span class="me-2">{{ field }}: <span class="text-decoration-line-through text-danger">{{ values.old_value|truncatechars:12 }}</span> → <span class="text-success">{{ values.new_value|truncatechars:12 }}</span></span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div id="log{{ log.id }}" class="collapse">
                        <div class="px-3 pb-3">
                            <div class="row g-2 small text-muted">
                                <div class="col-md-4 col-12"><i class="fas fa-database ms-1"></i><strong>مدل:</strong> {{ log.model_name|default:'-' }}</div>
                                <div class="col-md-4 col-12"><i class="fas fa-cube ms-1"></i><strong>شیء:</strong> {{ log.related_object|default:'-' }}</div>
                                <div class="col-md-4 col-12"><i class="fas fa-route ms-1"></i><strong>مسیر:</strong> {{ log.path|default:'-' }}</div>
                                <div class="col-md-4 col-12"><i class="fas fa-bolt ms-1"></i><strong>متد:</strong> {{ log.method|default:'-' }}</div>
                                <div class="col-md-4 col-12"><i class="fas fa-signal ms-1"></i><strong>کد وضعیت:</strong> {{ log.status_code|default:'-' }}</div>
                                <div class="col-12"><i class="fas fa-info-circle ms-1"></i><strong>جزئیات:</strong> {{ log.details|default:'-' }}</div>
                            </div>
                            <hr class="my-2">
                            <div>
                                <h6 class="small mb-2"><i class="fas fa-exchange-alt ms-1"></i>تغییرات</h6>
                                {% if log.changes and log.changes != '-' %}
                                    <div class="list-group list-group-flush">
                                        {% for field, values in log.changes.items %}
                                            <div class="list-group-item px-0 d-flex justify-content-between align-items-start">
                                                <div class="me-2"><strong>{{ field }}</strong></div>
                                                <div class="text-end small">
                                                    <div class="text-danger text-decoration-line-through">{{ values.old_value|default:'-' }}</div>
                                                    <div class="text-success">{{ values.new_value|default:'-' }}</div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted small mb-0"><i class="fas fa-ban ms-1"></i>بدون تغییرات</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-1">هیچ لاگی یافت نشد.</p>
                    <p class="text-muted small">فیلترها را تغییر دهید یا نمایش ردیف‌های بدون تغییر را فعال کنید.</p>
                </div>
            {% endfor %}
        </div>

        <!-- صفحه‌بندی -->
        {% if logs.has_other_pages %}
            <nav class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if logs.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page=1"><i class="fas fa-angle-double-left"></i></a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ logs.previous_page_number }}"><i class="fas fa-angle-left"></i></a></li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link">{{ logs.number }} / {{ logs.paginator.num_pages }}</span></li>
                    {% if logs.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ logs.next_page_number }}"><i class="fas fa-angle-right"></i></a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ logs.paginator.num_pages }}"><i class="fas fa-angle-double-right"></i></a></li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>

 {% endblock %}