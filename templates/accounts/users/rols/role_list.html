{% extends "base/base.html" %}

{% load static jformat rcms_custom_filters %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
    <div class="page-header mb-4 text-center">
        <h1 class="display-5 fw-bold">
            <i class="fas fa-user-shield me-2 text-primary"></i>Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        </h1>
        <p class="lead text-muted">Ø§ÛŒØ¬Ø§Ø¯ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ùˆ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
            <p class="small text-muted"> ğŸ“…Ø²Ù…Ø§Ù† Ú†Ø§Ù¾: {{  print_date_now |jformat:"%Y/%m/%d" |to_persian_number }} âŒš{{  print_time_now  |to_persian_number }} </p>
    </div>

    <!-- Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-primary text-white p-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                <!-- ÙØ±Ù… Ø¬Ø³ØªØ¬Ùˆ -->
                <form method="get" action="" class="d-flex align-items-center flex-grow-1 me-md-3 mb-3 mb-md-0">
                    <div class="input-group search-container shadow-sm">
                        <span class="input-group-text border-end-0 bg-white">
                            <i class="fas fa-search text-primary"></i>
                        </span>
                        <input type="text"
                               name="q"
                               id="roleSearch"
                               class="form-control border-start-0"
                               placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ù‚Ø´ØŒ ØªÙˆØ¶ÛŒØ­Ø§Øª ÛŒØ§ Ù…Ø¬ÙˆØ²..."
                               value="{{ query }}"
                               autocomplete="off"
                               aria-label="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ù‚Ø´">
                        <button type="button" class="btn btn-clear" id="clearSearch" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø³ØªØ¬Ùˆ">
                            <i class="fas fa-times"></i>
                        </button>
                        {% if show_inactive %}
                            <input type="hidden" name="show_inactive" value="true">
                        {% endif %}
                        <button class="btn btn-outline-primary" type="submit" aria-label="Ø¬Ø³ØªØ¬Ùˆ">Ø¬Ø³ØªØ¬Ùˆ</button>
                    </div>
                </form>

                <!-- ÙÛŒÙ„ØªØ± Ùˆ Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ -->
                <div class="d-flex align-items-center">
                    <div class="btn-group me-3" role="group" aria-label="ÙÛŒÙ„ØªØ± Ù†Ù‚Ø´â€ŒÙ‡Ø§">
                        <a href="?q={{ query }}" class="btn btn-outline-success {% if not show_inactive %}active{% endif %}" aria-current="{% if not show_inactive %}true{% else %}false{% endif %}">
                            <i class="fas fa-check-circle me-1"></i>ÙØ¹Ø§Ù„
                        </a>
                        <a href="?show_inactive=true&q={{ query }}" class="btn btn-outline-warning {% if show_inactive %}active{% endif %}" aria-current="{% if show_inactive %}true{% else %}false{% endif %}">
                            <i class="fas fa-ban me-1"></i>ØºÛŒØ±ÙØ¹Ø§Ù„
                        </a>
                    </div>
                    <a href="{% url 'accounts:role_create' %}" class="btn btn-primary" aria-label="Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´ Ø¬Ø¯ÛŒØ¯">
                        <i class="fas fa-plus-circle me-2"></i>Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´ Ø¬Ø¯ÛŒØ¯
                    </a>
                  <a href="{% url 'accounts:admin_dashboard' %}" class="btn btn-link" aria-label="Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯">
                        <i class="fas fa-plus-square-o me-2"></i>Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                    </a>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø¯Ù†Ù‡ Ø¬Ø¯ÙˆÙ„ -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="roles-table" aria-label="Ø¬Ø¯ÙˆÙ„ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 px-4" scope="col">Ù†Ø§Ù… Ù†Ù‚Ø´</th>
                            <th class="py-3 px-4" scope="col">Ù…Ø¬ÙˆØ²Ù‡Ø§</th>
                            <th class="py-3 px-4 text-center" scope="col">ÙˆØ¶Ø¹ÛŒØª</th>
                            <th class="py-3 px-4 text-center" scope="col">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for role in roles %}
                        <tr class="role-item">
                            <td class="align-middle px-4">
                                <strong class="d-block">{{ role.name }}</strong>
                                {% if role.description %}
                                    <small class="text-muted">{{ role.description|truncatechars:70 }}</small>
                                {% endif %}
                            </td>
                            <td class="align-middle px-4">
                                {% with permissions=role.permissions.all %}
                                    {% for perm in permissions|slice:":4" %}
                                        <span class="badge bg-secondary fw-normal">{{ perm.name }}</span>
                                    {% endfor %}
                                    {% if permissions.count > 4 %}
                                        <span class="badge bg-info fw-normal"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="{% for perm in permissions %}{{ perm.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                                            +{{ permissions.count|add:"-4" }} Ø¨ÛŒØ´ØªØ±
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="align-middle text-center px-4">
                                {% if role.is_active %}
                                    <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle">ÙØ¹Ø§Ù„</span>
                                {% else %}
                                    <span class="badge rounded-pill bg-danger-subtle text-danger-emphasis border border-danger-subtle">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center px-4">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'accounts:role_update' role.id %}">
                                                <i class="fas fa-edit me-2 text-primary"></i>ÙˆÛŒØ±Ø§ÛŒØ´
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'accounts:role_print' role.id %}" target="_blank">
                                                <i class="fas fa-print me-2 text-secondary"></i>Ú†Ø§Ù¾ Ù…Ø¬ÙˆØ²Ù‡Ø§
                                            </a>
                                        </li>
                                        {% if role.is_active %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <form method="post" action="{% url 'accounts:deactivate_role' role.id %}" class="form-deactivate-role">
                                                    {% csrf_token %}
                                                    <button type="submit" class="dropdown-item text-danger" aria-label="ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´">
                                                        <i class="fas fa-ban me-2"></i>ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù†
                                                    </button>
                                                </form>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr class="role-item">
                            <td colspan="4" class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h4 class="mb-2">Ù‡ÛŒÚ† Ù†Ù‚Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</h4>
                                <p class="text-muted">
                                    {% if query %}
                                        Ù‡ÛŒÚ† Ù†Ù‚Ø´ÛŒ Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.
                                    {% else %}
                                        Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù†Ù‚Ø´ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.
                                    {% endif %}
                                </p>
                                <a href="{% url 'accounts:role_create' %}" class="btn btn-primary mt-2" aria-label="Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´ Ø¬Ø¯ÛŒØ¯">
                                    <i class="fas fa-plus-circle me-2"></i> Ø§ÙˆÙ„ÛŒÙ† Ù†Ù‚Ø´ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
        {% if is_paginated and roles %}
        <div class="card-footer bg-light border-top d-flex justify-content-center py-3">
            <nav aria-label="Ù†Ø§ÙˆØ¨Ø±ÛŒ ØµÙØ­Ù‡">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}{% if show_inactive %}&show_inactive=true{% endif %}" aria-label="ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link" aria-hidden="true">&laquo;</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ query }}{% if show_inactive %}&show_inactive=true{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}{% if show_inactive %}&show_inactive=true{% endif %}" aria-label="ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link" aria-hidden="true">&raquo;</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Ú†Ú© Ú©Ù† jQuery Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡
    console.log('Ø¹Ø´Ù‚Ù… jQuery Ù„ÙˆØ¯ Ø´Ø¯!');

    // ÙˆÙ‚ØªÛŒ ØªÙˆ Ø¬Ø³ØªØ¬Ùˆ Ú†ÛŒØ²ÛŒ ØªØ§ÛŒÙ¾ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ
    $('#roleSearch').on('input', function() {
        let keyword = $(this).val().toLowerCase().trim();

        // Ø¯Ú©Ù…Ù‡ Ã— Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡ ÛŒØ§ Ù…Ø®ÙÛŒØ´ Ú©Ù†
        $('#clearSearch').css('visibility', keyword.length > 0 ? 'visible' : 'hidden');

        // Ø¨Ú¯Ø±Ø¯ Ø¨ÛŒÙ† Ù†Ù‚Ø´â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ú©Ù†
        $('.role-item').each(function() {
            let $row = $(this);
            let roleText = $row.text().toLowerCase();

            // Ø§ÙˆÙ„ Ù‡Ø§ÛŒÙ„Ø§ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
            $row.find('.highlight').contents().unwrap();

            if (keyword && roleText.includes(keyword)) {
                // Ø§Ú¯Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ú©Ù†
                $row.slideDown(300);

                // Ù…ØªÙ† Ø¯Ø§Ø®Ù„ Ù‡Ø± Ø³Ù„ÙˆÙ„ Ø±Ùˆ Ú†Ú© Ú©Ù† Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ú©Ù†
                $row.find('td').each(function() {
                    let $cell = $(this);
                    let cellText = $cell.text();
                    let lowerCellText = cellText.toLowerCase();

                    if (lowerCellText.includes(keyword)) {
                        let regex = new RegExp(`(${keyword})`, 'gi');
                        let newHtml = cellText.replace(regex, '<span class="highlight">$1</span>');
                        $cell.html(newHtml);
                    }
                });
            } else {
                // Ø§Ú¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ØºÛŒØ¨Ø´ Ø¨Ø²Ù†
                $row.slideUp(300);
            }
        });
    });

    // ÙˆÙ‚ØªÛŒ Ø¯Ú©Ù…Ù‡ Ã— Ø±Ùˆ Ù…ÛŒâ€ŒØ²Ù†ÛŒ
    $('#clearSearch').on('click', function() {
        $('#roleSearch').val('').trigger('input');
        $('.role-item').each(function() {
            $(this).slideDown(300);
            // Ù‡Ø§ÛŒÙ„Ø§ÛŒØªâ€ŒÙ‡Ø§ Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
            $(this).find('.highlight').contents().unwrap();
        });
    });

    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ "Ù†Ù‚Ø´ Ø¬Ø¯ÛŒØ¯"
    $('.btn-add-role').hover(
        function() {
            $(this).addClass('animate__animated animate__pulse');
        },
        function() {
            $(this).removeClass('animate__animated animate__pulse');
        }
    );

    // ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù†
    $('.deactivate').on('click', function(e) {
        if (!confirm('Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§ÛŒÙ† Ù†Ù‚Ø´ Ø±Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒ Ø¹Ø´Ù‚Ù…ØŸ')) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
