<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد گزارشات - سیستم بودجه</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js UMD from local -->
    <script src="/static/admin/js/chart.umd.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        
        .stats-card.budget .icon { background: linear-gradient(45deg, #667eea, #764ba2); }
        .stats-card.tankhah .icon { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .stats-card.factor .icon { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .stats-card.payment .icon { background: linear-gradient(45deg, #43e97b, #38f9d7); }
        
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
            color: #2d3748;
        }
        
        .stats-card p {
            color: #718096;
            margin: 5px 0 0 0;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #e53e3e;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="dashboard-container">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">داشبورد گزارشات بودجه</h1>
                <p class="lead text-muted">آمار و تحلیل‌های جامع سیستم مدیریت بودجه</p>
            </div>
            
            <!-- آمار کلی -->
            <div class="row mb-5">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card budget">
                        <div class="icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <h3 id="totalBudget">0</h3>
                        <p>کل بودجه (ریال)</p>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card tankhah">
                        <div class="icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <h3 id="totalTankhah">0</h3>
                        <p>تعداد تنخواه‌ها</p>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card factor">
                        <div class="icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h3 id="totalFactor">0</h3>
                        <p>تعداد فاکتورها</p>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card payment">
                        <div class="icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <h3 id="totalPayment">0</h3>
                        <p>دستورات پرداخت</p>
                    </div>
                </div>
            </div>
            
            <!-- نمودارها -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">توزیع بودجه بر اساس سازمان</div>
                        <canvas id="orgBudgetChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">مصرف بودجه در زمان</div>
                        <canvas id="monthlyConsumptionChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">وضعیت تنخواه‌ها</div>
                        <canvas id="tankhahStatusChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">دسته‌بندی فاکتورها</div>
                        <canvas id="factorCategoryChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // داده‌های داشبورد
        let dashboardData = {
            stats: {
                total_budget: 0,
                total_tankhah: 0,
                total_factor: 0,
                total_payment: 0
            },
            charts: {
                org_budget: [],
                monthly_consumption: [],
                tankhah_status: [],
                factor_category: []
            }
        };

        // بارگذاری داده‌ها
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                
                // دریافت داده‌های debug
                const response = await fetch('/reports/dashboard/debug-data/');
                const data = await response.json();
                
                console.log('Data received:', data);
                
                // به‌روزرسانی آمار
                updateStats(data);
                
                // به‌روزرسانی نمودارها
                updateCharts(data.chart_data);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('خطا در بارگذاری داده‌ها');
            }
        }

        // به‌روزرسانی آمار
        function updateStats(data) {
            document.getElementById('totalBudget').textContent = formatNumber(data.total_budget || 0);
            document.getElementById('totalTankhah').textContent = formatNumber(data.org_budget_count || 0);
            document.getElementById('totalFactor').textContent = formatNumber(data.factor_category_count || 0);
            document.getElementById('totalPayment').textContent = formatNumber(data.tankhah_status_count || 0);
        }

        // به‌روزرسانی نمودارها
        function updateCharts(chartData) {
            if (!chartData) {
                console.log('No chart data available');
                return;
            }

            // نمودار توزیع بودجه
            createOrgBudgetChart(chartData.org_budget || []);
            
            // نمودار مصرف ماهانه
            createMonthlyConsumptionChart(chartData.monthly_consumption || []);
            
            // نمودار وضعیت تنخواه‌ها
            createTankhahStatusChart(chartData.tankhah_status || []);
            
            // نمودار دسته‌بندی فاکتورها
            createFactorCategoryChart(chartData.factor_category || []);
        }

        // نمودار توزیع بودجه
        function createOrgBudgetChart(data) {
            const ctx = document.getElementById('orgBudgetChart');
            if (!ctx || !data.length) {
                showEmpty(ctx, 'داده‌ای برای نمایش وجود ندارد');
                return;
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.organization__name || 'نامشخص'),
                    datasets: [{
                        data: data.map(item => item.total || 0),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatNumber(context.parsed) + ' ریال';
                                }
                            }
                        }
                    }
                }
            });
        }

        // نمودار مصرف ماهانه
        function createMonthlyConsumptionChart(data) {
            const ctx = document.getElementById('monthlyConsumptionChart');
            if (!ctx || !data.length) {
                showEmpty(ctx, 'داده‌ای برای نمایش وجود ندارد');
                return;
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => {
                        const date = new Date(item.month);
                        return date.toLocaleDateString('fa-IR');
                    }),
                    datasets: [{
                        label: 'مصرف بودجه',
                        data: data.map(item => item.total || 0),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'مصرف: ' + formatNumber(context.parsed.y) + ' ریال';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // نمودار وضعیت تنخواه‌ها
        function createTankhahStatusChart(data) {
            const ctx = document.getElementById('tankhahStatusChart');
            if (!ctx || !data.length) {
                showEmpty(ctx, 'داده‌ای برای نمایش وجود ندارد');
                return;
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.status__name || 'نامشخص'),
                    datasets: [{
                        label: 'تعداد',
                        data: data.map(item => item.count || 0),
                        backgroundColor: '#f093fb',
                        borderColor: '#f5576c',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // نمودار دسته‌بندی فاکتورها
        function createFactorCategoryChart(data) {
            const ctx = document.getElementById('factorCategoryChart');
            if (!ctx || !data.length) {
                showEmpty(ctx, 'داده‌ای برای نمایش وجود ندارد');
                return;
            }

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => item.category__name || 'نامشخص'),
                    datasets: [{
                        data: data.map(item => item.total || 0),
                        backgroundColor: [
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                            '#667eea', '#764ba2', '#f093fb', '#f5576c'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatNumber(context.parsed) + ' ریال';
                                }
                            }
                        }
                    }
                }
            });
        }

        // نمایش پیام خالی
        function showEmpty(canvas, message) {
            if (canvas) {
                canvas.parentElement.innerHTML = `
                    <div class="empty">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        // نمایش خطا
        function showError(message) {
            console.error(message);
            // می‌توانید یک notification یا alert اضافه کنید
        }

        // فرمت کردن اعداد
        function formatNumber(num) {
            return new Intl.NumberFormat('fa-IR').format(num);
        }

        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded, initializing...');
            loadDashboardData();
        });
    </script>
</body>
</html>
