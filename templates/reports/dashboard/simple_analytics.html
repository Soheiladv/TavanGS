<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیل‌های پیشرفته بودجه</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js UMD from local -->
    <script src="/static/admin/js/chart.umd.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .analytics-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .table-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="analytics-container">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">تحلیل‌های پیشرفته بودجه</h1>
                <p class="lead text-muted">تحلیل جامع و گزارش‌های تفصیلی سیستم بودجه</p>
            </div>
            
            <!-- آمار کلیدی -->
            <div class="row mb-5">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="metric-card">
                        <div class="metric-value" id="totalAllocated">0</div>
                        <div class="metric-label">کل تخصیص بودجه</div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="metric-card">
                        <div class="metric-value" id="totalConsumed">0</div>
                        <div class="metric-label">کل مصرف بودجه</div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="metric-card">
                        <div class="metric-value" id="totalReturned">0</div>
                        <div class="metric-label">کل برگشت بودجه</div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="metric-card">
                        <div class="metric-value" id="remaining">0</div>
                        <div class="metric-label">بودجه باقی‌مانده</div>
                    </div>
                </div>
            </div>
            
            <!-- نمودارها -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">توزیع بودجه (تخصیص، مصرف، برگشت)</div>
                        <canvas id="budgetDistributionChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">روند برگشت بودجه</div>
                        <canvas id="returnTrendChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-12 mb-4">
                    <div class="chart-container">
                        <div class="chart-title">مقایسه روند مصرف و برگشت</div>
                        <canvas id="trendComparisonChart" width="800" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- جداول -->
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="table-container">
                        <div class="table-title">دلایل برگشت</div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>دلیل</th>
                                        <th>تعداد</th>
                                        <th>مبلغ</th>
                                    </tr>
                                </thead>
                                <tbody id="returnReasonsTable">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">در حال بارگذاری...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="table-container">
                        <div class="table-title">برگشت بر اساس سازمان</div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>سازمان</th>
                                        <th>تعداد</th>
                                        <th>مبلغ</th>
                                        <th>درصد</th>
                                    </tr>
                                </thead>
                                <tbody id="orgReturnsTable">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">در حال بارگذاری...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="table-container">
                        <div class="table-title">برگشت بر اساس پروژه</div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>پروژه</th>
                                        <th>تعداد</th>
                                        <th>مبلغ</th>
                                        <th>درصد</th>
                                    </tr>
                                </thead>
                                <tbody id="projectReturnsTable">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">در حال بارگذاری...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // داده‌های analytics
        let analyticsData = {
            budget_analysis: {},
            return_analysis: {},
            trend_analysis: {}
        };

        // بارگذاری داده‌های analytics
        async function loadAnalyticsData() {
            try {
                console.log('Loading analytics data...');
                
                // دریافت داده‌های debug
                const response = await fetch('/reports/dashboard/debug-data/');
                const data = await response.json();
                
                console.log('Analytics data received:', data);
                
                // شبیه‌سازی داده‌های analytics
                analyticsData.budget_analysis = {
                    total_allocated: data.total_allocated || 0,
                    total_consumed: data.total_allocated * 0.7 || 0,
                    total_returned: data.total_allocated * 0.1 || 0
                };
                
                analyticsData.return_analysis = {
                    stats: {
                        total_amount: data.total_allocated * 0.1 || 0
                    },
                    reason_stats: [
                        { description: 'عدم نیاز', count: 5, total: 1000000 },
                        { description: 'خطای تخصیص', count: 3, total: 500000 },
                        { description: 'تغییر برنامه', count: 2, total: 300000 }
                    ],
                    org_returns: [
                        { allocation__organization__name: 'سازمان ۱', count: 3, total_amount: 800000 },
                        { allocation__organization__name: 'سازمان ۲', count: 2, total_amount: 600000 }
                    ],
                    project_returns: [
                        { allocation__project__name: 'پروژه A', count: 2, total_amount: 700000 },
                        { allocation__project__name: 'پروژه B', count: 1, total_amount: 500000 }
                    ]
                };
                
                analyticsData.trend_analysis = {
                    return_trend: [
                        { month: '2024-01-01', total: 200000 },
                        { month: '2024-02-01', total: 300000 },
                        { month: '2024-03-01', total: 250000 },
                        { month: '2024-04-01', total: 400000 }
                    ],
                    consumption_trend: [
                        { month: '2024-01-01', total: 1500000 },
                        { month: '2024-02-01', total: 1800000 },
                        { month: '2024-03-01', total: 1600000 },
                        { month: '2024-04-01', total: 2000000 }
                    ]
                };
                
                // به‌روزرسانی UI
                updateMetrics();
                updateCharts();
                updateTables();
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showError('خطا در بارگذاری داده‌ها');
            }
        }

        // به‌روزرسانی آمار
        function updateMetrics() {
            const budget = analyticsData.budget_analysis;
            const totalAllocated = budget.total_allocated || 0;
            const totalConsumed = budget.total_consumed || 0;
            const totalReturned = budget.total_returned || 0;
            const remaining = totalAllocated - totalConsumed + totalReturned;
            
            document.getElementById('totalAllocated').textContent = formatNumber(totalAllocated);
            document.getElementById('totalConsumed').textContent = formatNumber(totalConsumed);
            document.getElementById('totalReturned').textContent = formatNumber(totalReturned);
            document.getElementById('remaining').textContent = formatNumber(remaining);
        }

        // به‌روزرسانی نمودارها
        function updateCharts() {
            createBudgetDistributionChart();
            createReturnTrendChart();
            createTrendComparisonChart();
        }

        // نمودار توزیع بودجه
        function createBudgetDistributionChart() {
            const ctx = document.getElementById('budgetDistributionChart');
            const budget = analyticsData.budget_analysis;
            
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['تخصیص', 'مصرف', 'برگشت'],
                    datasets: [{
                        data: [
                            budget.total_allocated || 0,
                            budget.total_consumed || 0,
                            budget.total_returned || 0
                        ],
                        backgroundColor: ['#667eea', '#f093fb', '#4facfe'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatNumber(context.parsed) + ' ریال';
                                }
                            }
                        }
                    }
                }
            });
        }

        // نمودار روند برگشت
        function createReturnTrendChart() {
            const ctx = document.getElementById('returnTrendChart');
            const trend = analyticsData.trend_analysis.return_trend || [];
            
            if (!ctx || !trend.length) {
                showEmpty(ctx, 'داده‌ای برای نمایش وجود ندارد');
                return;
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trend.map(item => {
                        const date = new Date(item.month);
                        return date.toLocaleDateString('fa-IR');
                    }),
                    datasets: [{
                        label: 'برگشت بودجه',
                        data: trend.map(item => item.total || 0),
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'برگشت: ' + formatNumber(context.parsed.y) + ' ریال';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // نمودار مقایسه روند
        function createTrendComparisonChart() {
            const ctx = document.getElementById('trendComparisonChart');
            const returnTrend = analyticsData.trend_analysis.return_trend || [];
            const consumptionTrend = analyticsData.trend_analysis.consumption_trend || [];
            
            if (!ctx) return;
            
            const labels = returnTrend.length > 0 ? 
                returnTrend.map(item => {
                    const date = new Date(item.month);
                    return date.toLocaleDateString('fa-IR');
                }) : 
                consumptionTrend.map(item => {
                    const date = new Date(item.month);
                    return date.toLocaleDateString('fa-IR');
                });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'مصرف بودجه',
                            data: consumptionTrend.map(item => item.total || 0),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'برگشت بودجه',
                            data: returnTrend.map(item => item.total || 0),
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y) + ' ریال';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // به‌روزرسانی جداول
        function updateTables() {
            updateReturnReasonsTable();
            updateOrgReturnsTable();
            updateProjectReturnsTable();
        }

        // جدول دلایل برگشت
        function updateReturnReasonsTable() {
            const tbody = document.getElementById('returnReasonsTable');
            const reasons = analyticsData.return_analysis.reason_stats || [];
            
            if (reasons.length > 0) {
                tbody.innerHTML = reasons.map(reason => `
                    <tr>
                        <td>${reason.description || 'نامشخص'}</td>
                        <td><span class="badge bg-primary">${reason.count || 0}</span></td>
                        <td>${formatNumber(reason.total || 0)}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">داده‌ای یافت نشد</td></tr>';
            }
        }

        // جدول برگشت سازمان‌ها
        function updateOrgReturnsTable() {
            const tbody = document.getElementById('orgReturnsTable');
            const orgReturns = analyticsData.return_analysis.org_returns || [];
            const totalAmount = analyticsData.return_analysis.stats?.total_amount || 0;
            
            if (orgReturns.length > 0) {
                tbody.innerHTML = orgReturns.map(org => {
                    const percentage = totalAmount > 0 ? ((org.total_amount || 0) / totalAmount * 100).toFixed(1) : '0';
                    return `
                        <tr>
                            <td>${org.allocation__organization__name || 'نامشخص'}</td>
                            <td><span class="badge bg-primary">${org.count || 0}</span></td>
                            <td>${formatNumber(org.total_amount || 0)}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">داده‌ای یافت نشد</td></tr>';
            }
        }

        // جدول برگشت پروژه‌ها
        function updateProjectReturnsTable() {
            const tbody = document.getElementById('projectReturnsTable');
            const projectReturns = analyticsData.return_analysis.project_returns || [];
            const totalAmount = analyticsData.return_analysis.stats?.total_amount || 0;
            
            if (projectReturns.length > 0) {
                tbody.innerHTML = projectReturns.map(project => {
                    const percentage = totalAmount > 0 ? ((project.total_amount || 0) / totalAmount * 100).toFixed(1) : '0';
                    return `
                        <tr>
                            <td>${project.allocation__project__name || 'نامشخص'}</td>
                            <td><span class="badge bg-success">${project.count || 0}</span></td>
                            <td>${formatNumber(project.total_amount || 0)}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">داده‌ای یافت نشد</td></tr>';
            }
        }

        // نمایش پیام خالی
        function showEmpty(canvas, message) {
            if (canvas) {
                canvas.parentElement.innerHTML = `
                    <div class="empty">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        // نمایش خطا
        function showError(message) {
            console.error(message);
        }

        // فرمت کردن اعداد
        function formatNumber(num) {
            return new Intl.NumberFormat('fa-IR').format(num);
        }

        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Analytics loaded, initializing...');
            loadAnalyticsData();
        });
    </script>
</body>
</html>
